<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Service Request Scanner</title>

<style>
body {
  font-family: Arial, sans-serif;
  background: #eef2f5;
  margin: 0;
  padding: 15px;
}

.logo { text-align:center; margin-bottom:10px; }
.logo img { max-height:80px; }

h2 { text-align:center; color:#003366; }

#reader { width:100%; max-width:360px; margin:auto; }

.card {
  background:#ffffff;
  border-radius:10px;
  padding:15px;
  margin-top:15px;
  box-shadow:0 2px 8px rgba(0,0,0,0.15);
}

.row {
  display:grid;
  grid-template-columns:150px 10px auto;
  align-items:center;
  margin-bottom:6px;
}

.label { font-weight:bold; }
.colon { text-align:center; font-weight:bold; }
.value { font-size:14px; }

.btn {
  width:100%;
  padding:12px;
  margin-top:8px;
  border:none;
  border-radius:6px;
  background:#0066cc;
  color:white;
  font-size:15px;
  cursor:pointer;
}
</style>
</head>

<body>

<div class="logo">
  <img src="logo.jpg">
</div>

<h2>Hospital Service Request</h2>

<div id="reader"></div>
<div id="assetCard" class="card" style="display:none;"></div>

<script src="https://unpkg.com/html5-qrcode"></script>

<script>
/* ===============================
   DEPARTMENT â†’ APPS SCRIPT MAP
================================ */
const SCRIPT_MAP = {
  BIO: "https://script.google.com/macros/s/BIO_SCRIPT_ID/exec",
  IT:  "https://script.google.com/macros/s/IT_SCRIPT_ID/exec",
  MT:  "https://script.google.com/macros/s/MT_SCRIPT_ID/exec"
};

/* ===============================
   ASSET MASTER (CENTRAL)
================================ */
const SHEET_URL =
"https://opensheet.elk.sh/1e3JNAbJhkYirQwN5ox5rcG5BvP3VosTMoZQkIuL3ypA/Asset_Master";

const assetCard = document.getElementById("assetCard");

/* ===============================
   DISPLAY ASSET
================================ */
function showAsset(a, deptCode, scriptUrl) {
  assetCard.innerHTML = `
    <div class="row"><div class="label">Asset No</div><div class="colon">:</div><div class="value">${a.Asset_No}</div></div>
    <div class="row"><div class="label">Department</div><div class="colon">:</div><div class="value">${a.Department}</div></div>
    <div class="row"><div class="label">Equipment</div><div class="colon">:</div><div class="value">${a.Equipment}</div></div>
    <div class="row"><div class="label">Model</div><div class="colon">:</div><div class="value">${a.Model}</div></div>
    <div class="row"><div class="label">Make</div><div class="colon">:</div><div class="value">${a.Make}</div></div>
    <div class="row"><div class="label">Serial No</div><div class="colon">:</div><div class="value">${a.Serial_No}</div></div>

    <hr>

    <button class="btn" onclick="
      window.open(
        '${scriptUrl}?page=complaint&asset=${a.Asset_No}',
        '_blank'
      )
    ">
      Report Breakdown
    </button>

    <button class="btn" onclick="
      window.open(
        '${scriptUrl}?page=close&asset=${a.Asset_No}',
        '_blank'
      )
    ">
      Close Breakdown
    </button>
  `;
  assetCard.style.display = "block";
}

/* ===============================
   QR CAMERA
================================ */
const qr = new Html5Qrcode("reader");

Html5Qrcode.getCameras().then(cams => {
  const cam = cams.find(c => c.label.toLowerCase().includes("back")) || cams[0];

  qr.start(cam.id, { fps: 15, qrbox: 280 }, qrText => {
    qr.stop();

    /* ----- PARSE QR ----- */
    const parts = qrText.trim().split("|");
    if (parts.length !== 2) {
      alert("Invalid QR Code Format");
      return;
    }

    const deptCode = parts[0];
    const assetNo  = parts[1];

    const scriptUrl = SCRIPT_MAP[deptCode];
    if (!scriptUrl) {
      alert("Unknown Department QR");
      return;
    }

    /* ----- FETCH ASSET ----- */
    fetch(SHEET_URL)
      .then(res => res.json())
      .then(data => {
        const asset = data.find(a => a.Asset_No === assetNo);
        if (!asset) {
          alert("Asset not found");
          return;
        }
        showAsset(asset, deptCode, scriptUrl);
      });
  });
});
</script>

</body>
</html>
